<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RE:FOOD - íšŒì› ê´€ë¦¬</title>
    <!-- ì¹´ì¹´ì˜¤ SDK v1.39.10 -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            margin-bottom: 1rem;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .kakao-btn {
            background-color: #FEE500;
            color: #000;
        }

        .kakao-btn:hover {
            background-color: #FDD835;
            transform: translateY(-2px);
        }

        .signup-btn {
            background-color: #4CAF50;
            color: white;
        }

        .signup-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .update-btn {
            background-color: #2196F3;
            color: white;
        }

        .update-btn:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }

        .logout-btn {
            background-color: #f44336;
            color: white;
        }

        .logout-btn:hover {
            background-color: #da190b;
            transform: translateY(-2px);
        }

        .back-btn {
            background-color: #9E9E9E;
            color: white;
            width: auto;
            padding: 0.75rem 1.5rem;
            margin-bottom: 1rem;
        }

        .back-btn:hover {
            background-color: #757575;
            transform: translateY(-2px);
        }

        .user-info {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .validation-message {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .validation-message.success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .validation-message.error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .status {
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }

        .hidden { display: none; }

        .check-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .check-btn:hover {
            background: #138496;
        }

        .input-with-check {
            display: flex;
            align-items: center;
        }

        .input-with-check input {
            flex: 1;
            margin-right: 0.5rem;
        }

        .user-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .current-nickname {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #4CAF50;
        }

        .current-nickname strong {
            color: #4CAF50;
        }

        /* íšŒì› íƒ€ì… ì„ íƒ ìŠ¤íƒ€ì¼ */
        .member-type-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
        }

        .member-type-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
            text-align: center;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .radio-item:hover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .radio-item.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }

        /* ê°œì¸ íšŒì› ì „ìš© í•„ë“œ ìŠ¤íƒ€ì¼ */
        .user-fields {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .user-fields.hide {
            display: none;
        }

        /* ì‚¬ì—…ì ë²ˆí˜¸ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .business-fields {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .business-fields.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo">ğŸŒ± RE:FOOD</div>
    <div class="subtitle">íšŒì› ê´€ë¦¬ ì‹œìŠ¤í…œ</div>

    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div id="loginSection">
        <button class="btn kakao-btn" onclick="handleKakaoLogin()">
            <span>ğŸ’¬</span>
            ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸í•˜ê¸°
        </button>
    </div>

    <!-- íšŒì›ê°€ì… ì„¹ì…˜ -->
    <div id="signupSection" class="hidden">
        <div class="status info">ì‹ ê·œ íšŒì›ì…ë‹ˆë‹¤. íšŒì› ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>

        <!-- íšŒì› íƒ€ì… ì„ íƒ -->
        <div class="member-type-section">
            <div class="member-type-title">íšŒì› ìœ í˜• ì„ íƒ</div>
            <div class="radio-group">
                <div class="radio-item selected" onclick="selectMemberType('user', this)">
                    <input type="radio" name="memberType" value="user" checked>
                    <span>ğŸ‘¤ ê°œì¸ íšŒì›</span>
                </div>
                <div class="radio-item" onclick="selectMemberType('store', this)">
                    <input type="radio" name="memberType" value="store">
                    <span>ğŸª ì‚¬ì—…ì íšŒì›</span>
                </div>
            </div>
        </div>

        <!-- ê°œì¸ íšŒì› ì „ìš© í•„ë“œ -->
        <div id="userFields" class="user-fields">
            <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„ *</label>
                <div class="input-with-check">
                    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" class="check-btn" onclick="checkNickname()">ì¤‘ë³µí™•ì¸</button>
                </div>
                <div id="nicknameValidation" class="validation-message" style="display: none;"></div>
            </div>

            <div class="form-group">
                <label for="phone">ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phone" placeholder="01012345678" pattern="^01[0-9]{8,9}$">
                <div id="phoneValidation" class="validation-message" style="display: none;"></div>
            </div>

            <div class="form-group">
                <label for="address">ì£¼ì†Œ *</label>
                <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
        </div>

        <!-- ì‚¬ì—…ì íšŒì› ì „ìš© í•„ë“œ -->
        <div id="businessFields" class="business-fields">
            <div class="form-group">
                <label for="businessPhone">ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="businessPhone" placeholder="01012345678" pattern="^01[0-9]{8,9}$">
                <div id="businessPhoneValidation" class="validation-message" style="display: none;"></div>
            </div>

            <div class="form-group">
                <label for="businessLicense">ì‚¬ì—…ì ë²ˆí˜¸ *</label>
                <input type="text" id="businessLicense" placeholder="123-45-67890"
                       pattern="^\d{3}-\d{2}-\d{5}$|^\d{10}$">
                <div id="businessValidation" class="validation-message" style="display: none;"></div>
                <small style="color: #666;">í˜•ì‹: 123-45-67890 ë˜ëŠ” 1234567890</small>
            </div>
        </div>

        <button class="btn signup-btn" onclick="signupUser()">
            íšŒì›ê°€ì… ì™„ë£Œ
        </button>
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ ì„¹ì…˜ -->
    <div id="userSection" class="hidden">
        <div class="user-info">
            <h3>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰</h3>
            <div id="userInfo"></div>
        </div>

        <div class="user-menu">
            <button class="btn update-btn" onclick="goToMyPage()">
                <span>ğŸ‘¤</span>
                ë§ˆì´í˜ì´ì§€
            </button>
            <button class="btn update-btn" onclick="showNicknameUpdateSection()">
                <span>âœï¸</span>
                ë‹‰ë„¤ì„ ìˆ˜ì •í•˜ê¸°
            </button>
            <button class="btn logout-btn" onclick="logout()">
                <span>ğŸšª</span>
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <!-- ë‹‰ë„¤ì„ ìˆ˜ì • ì„¹ì…˜ -->
    <div id="nicknameUpdateSection" class="hidden">
        <button class="btn back-btn" onclick="showUserSection()">
            <span>â†</span>
            ë’¤ë¡œê°€ê¸°
        </button>

        <h3 style="margin-bottom: 1rem; color: #333;">ë‹‰ë„¤ì„ ìˆ˜ì •</h3>

        <div class="current-nickname">
            <strong>í˜„ì¬ ë‹‰ë„¤ì„:</strong> <span id="currentNickname"></span>
        </div>

        <div class="form-group">
            <label for="newNickname">ìƒˆ ë‹‰ë„¤ì„ *</label>
            <div class="input-with-check">
                <input type="text" id="newNickname" placeholder="ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <button type="button" class="check-btn" onclick="checkNewNickname()">ì¤‘ë³µí™•ì¸</button>
            </div>
            <div id="newNicknameValidation" class="validation-message" style="display: none;"></div>
        </div>

        <button class="btn update-btn" onclick="updateNickname()">
            <span>âœ…</span>
            ë‹‰ë„¤ì„ ë³€ê²½
        </button>
    </div>

    <div id="statusDiv"></div>
</div>

<script>
    let currentAccessToken = null;
    let kakaoInitialized = false;
    let selectedMemberType = 'user';
    let currentUserData = null;

    // ì¤‘ë³µ í™•ì¸ ìƒíƒœ ê´€ë¦¬
    let validationStatus = {
        nickname: false,
        phone: false,
        businessPhone: false,
        businessLicense: false,
        newNickname: false
    };

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    window.addEventListener('load', function() {
        console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì‹œì‘...');

        if (typeof Kakao !== 'undefined') {
            try {
                Kakao.init("171831cd15632cbfaac40ae9f7604a6f");
                console.log('ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì„±ê³µ');
                kakaoInitialized = true;
            } catch (error) {
                console.error('ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // ê¸°ì¡´ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const savedToken = localStorage.getItem('accessToken');
        const savedUserInfo = localStorage.getItem('userInfo');

        if (savedToken && savedUserInfo) {
            currentUserData = JSON.parse(savedUserInfo);
            showUserSection();
        }
    });

    // íšŒì› íƒ€ì… ì„ íƒ í•¨ìˆ˜
    function selectMemberType(type, element) {
        selectedMemberType = type;

        document.querySelectorAll('.radio-item').forEach(item => {
            item.classList.remove('selected');
        });

        element.classList.add('selected');
        element.querySelector('input[type="radio"]').checked = true;

        const businessFields = document.getElementById('businessFields');
        const userFields = document.getElementById('userFields');

        if (type === 'store') {
            businessFields.classList.add('show');
            userFields.classList.add('hide');
            clearUserFields();
        } else {
            businessFields.classList.remove('show');
            userFields.classList.remove('hide');
            clearBusinessFields();
        }
    }

    function clearUserFields() {
        document.getElementById('nickname').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('address').value = '';
        hideValidation('nicknameValidation');
        hideValidation('phoneValidation');
        validationStatus.nickname = false;
        validationStatus.phone = false;
    }

    function clearBusinessFields() {
        document.getElementById('businessPhone').value = '';
        document.getElementById('businessLicense').value = '';
        hideValidation('businessPhoneValidation');
        hideValidation('businessValidation');
        validationStatus.businessPhone = false;
        validationStatus.businessLicense = false;
    }

    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('statusDiv');
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        console.log(`[${type.toUpperCase()}] ${message}`);
        setTimeout(() => statusDiv.innerHTML = '', 5000);
    }

    function handleKakaoLogin() {
        if (!kakaoInitialized) {
            showStatus('ì¹´ì¹´ì˜¤ SDKê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            Kakao.Auth.login({
                success: function(authObj) {
                    console.log('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ:', authObj);
                    currentAccessToken = authObj.access_token;
                    showStatus('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ! ë°±ì—”ë“œë¡œ í† í° ì „ì†¡ ì¤‘...', 'success');
                    sendTokenToBackend(authObj.access_token);
                },
                fail: function(err) {
                    console.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨:', err);
                    showStatus('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        } catch (error) {
            console.error('ë¡œê·¸ì¸ í•¨ìˆ˜ ì‹¤í–‰ ì˜¤ë¥˜:', error);
            showStatus('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¤‘ë³µ í™•ì¸ í•¨ìˆ˜ë“¤
    async function checkNickname() {
        const nickname = document.getElementById('nickname').value.trim();
        if (!nickname) {
            showValidation('nicknameValidation', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/members/check/nickname?nickname=${encodeURIComponent(nickname)}`);
            const data = await response.json();

            if (data.data) {
                showValidation('nicknameValidation', 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', 'success');
                validationStatus.nickname = true;
            } else {
                showValidation('nicknameValidation', 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', 'error');
                validationStatus.nickname = false;
            }
        } catch (error) {
            showValidation('nicknameValidation', 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            validationStatus.nickname = false;
        }
    }

    async function checkNewNickname() {
        const newNickname = document.getElementById('newNickname').value.trim();
        if (!newNickname) {
            showValidation('newNicknameValidation', 'ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•œì§€ í™•ì¸
        if (currentUserData && newNickname === currentUserData.nickname) {
            showValidation('newNicknameValidation', 'í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤.', 'error');
            validationStatus.newNickname = false;
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/members/check/nickname?nickname=${encodeURIComponent(newNickname)}`);
            const data = await response.json();

            if (data.data) {
                showValidation('newNicknameValidation', 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', 'success');
                validationStatus.newNickname = true;
            } else {
                showValidation('newNicknameValidation', 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', 'error');
                validationStatus.newNickname = false;
            }
        } catch (error) {
            showValidation('newNicknameValidation', 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            validationStatus.newNickname = false;
        }
    }

    function showValidation(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `validation-message ${type}`;
        element.style.display = 'block';
    }

    function hideValidation(elementId) {
        const element = document.getElementById(elementId);
        element.style.display = 'none';
    }

    async function sendTokenToBackend(accessToken) {
        try {
            showStatus('ê¸°ì¡´ íšŒì› í™•ì¸ ì¤‘...', 'info');

            // ğŸ” FCM í† í° í™•ì¸ (ì‹¤ì œë¡œëŠ” FCM SDKì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            const fcmToken = localStorage.getItem('fcmToken'); // ì„ì‹œë¡œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ
            console.log('ğŸ” ì „ì†¡í•  FCM í† í°:', fcmToken);

            const requestBody = {
                accessToken: accessToken,
                fcmToken: fcmToken // FCM í† í° í¬í•¨
            };

            console.log('ğŸ” ë¡œê·¸ì¸ ìš”ì²­ ë°ì´í„°:', requestBody);

            const loginResponse = await fetch('http://localhost:8080/api/auth/login/members', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (loginResponse.ok) {
                const loginData = await loginResponse.json();
                console.log('âœ… ë¡œê·¸ì¸ ì‘ë‹µ:', loginData);
                console.log('âœ… ì‘ë‹µì˜ FCM í† í°:', loginData.data.fcmToken);

                showStatus('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                handleLoginSuccess(loginData.data);
            } else {
                showStatus('ì‹ ê·œ íšŒì›ì…ë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.', 'info');
                showSignupSection();
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            showStatus('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    function showSignupSection() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('signupSection').classList.remove('hidden');
        document.getElementById('userSection').classList.add('hidden');
        document.getElementById('nicknameUpdateSection').classList.add('hidden');
    }

    async function signupUser() {
        if (!currentAccessToken) {
            showStatus('ì¹´ì¹´ì˜¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            showStatus('íšŒì›ê°€ì… ì¤‘...', 'info');

            let requestData;
            let apiUrl;

            if (selectedMemberType === 'user') {
                const nickname = document.getElementById('nickname').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const address = document.getElementById('address').value.trim();

                if (!nickname || !address) {
                    showStatus('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                if (!validationStatus.nickname) {
                    showStatus('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                requestData = {
                    accessToken: currentAccessToken,
                    nickname: nickname,
                    phone: phone || null,
                    address: address
                };

                apiUrl = 'http://localhost:8080/api/auth/signup/members';
            } else {
                const phone = document.getElementById('businessPhone').value.trim();
                const businessLicense = document.getElementById('businessLicense').value.trim();

                if (!businessLicense) {
                    showStatus('ì‚¬ì—…ì ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                requestData = {
                    accessToken: currentAccessToken,
                    businessLicenseNumber: businessLicense,
                    phone: phone || null
                };

                apiUrl = 'http://localhost:8080/api/auth/signup/stores';
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                const data = await response.json();
                showStatus('íšŒì›ê°€ì… ì„±ê³µ!', 'success');
                handleLoginSuccess(data.data);
            } else {
                const errorData = await response.json();
                showStatus('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            showStatus('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    function handleLoginSuccess(userData) {
        localStorage.setItem('accessToken', userData.accessToken);
        localStorage.setItem('refreshToken', userData.refreshToken);
        localStorage.setItem('userInfo', JSON.stringify(userData));

        currentUserData = userData;
        showUserSection();
    }

    function showUserSection() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('signupSection').classList.add('hidden');
        document.getElementById('userSection').classList.remove('hidden');
        document.getElementById('nicknameUpdateSection').classList.add('hidden');

        if (currentUserData) {
            displayUserInfo(currentUserData);
        }
    }

    // ë§ˆì´í˜ì´ì§€ ì´ë™
    function goToMyPage() {
        if (currentUserData) {
            window.location.href = 'mypage.html';
        } else {
            showStatus('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
        }
    }

    function showNicknameUpdateSection() {
        // ê°œì¸ íšŒì›ì´ ì•„ë‹ˆë©´ ë‹‰ë„¤ì„ ìˆ˜ì • ë¶ˆê°€
        if (!currentUserData || currentUserData.role !== 'ROLE_USER') {
            showStatus('ê°œì¸ íšŒì›ë§Œ ë‹‰ë„¤ì„ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('signupSection').classList.add('hidden');
        document.getElementById('userSection').classList.add('hidden');
        document.getElementById('nicknameUpdateSection').classList.remove('hidden');

        // í˜„ì¬ ë‹‰ë„¤ì„ í‘œì‹œ
        document.getElementById('currentNickname').textContent = currentUserData.nickname || 'ì—†ìŒ';

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('newNickname').value = '';
        hideValidation('newNicknameValidation');
        validationStatus.newNickname = false;
    }

    function displayUserInfo(userData) {
        const memberTypeText = userData.role === 'ROLE_STORE' ? 'ğŸª ì‚¬ì—…ì íšŒì›' : 'ğŸ‘¤ ê°œì¸ íšŒì›';
        const businessInfo = userData.role === 'ROLE_STORE' && userData.businessLicenseNumber
            ? `<p><strong>ì‚¬ì—…ì ë²ˆí˜¸:</strong> ${userData.businessLicenseNumber}</p>`
            : '';
        const businessApprovalInfo = userData.role === 'ROLE_STORE'
            ? `<p><strong>ì‚¬ì—…ì ìŠ¹ì¸ ìƒíƒœ:</strong> ${userData.isBusinessApproved || 'ë¯¸ìŠ¹ì¸'}</p>`
            : '';

        const userInfoHtml = `
            <p><strong>ID:</strong> ${userData.id}</p>
            <p><strong>íšŒì› ìœ í˜•:</strong> ${memberTypeText}</p>
            <p><strong>ì´ë©”ì¼:</strong> ${userData.email}</p>
            <p><strong>ë‹‰ë„¤ì„:</strong> ${userData.nickname || 'ì—†ìŒ'}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${userData.phone || 'ì—†ìŒ'}</p>
            ${businessInfo}
            ${businessApprovalInfo}
            <p><strong>í™˜ê²½ ë ˆë²¨:</strong> ${userData.environmentLevel}</p>
            <p><strong>ì£¼ì†Œ:</strong> ${userData.location ? userData.location.address : 'ì—†ìŒ'}</p>
        `;
        document.getElementById('userInfo').innerHTML = userInfoHtml;
    }

    async function updateNickname() {
        const newNickname = document.getElementById('newNickname').value.trim();

        if (!newNickname) {
            showStatus('ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (!validationStatus.newNickname) {
            showStatus('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            showStatus('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            showStatus('ë‹‰ë„¤ì„ ìˆ˜ì • ì¤‘...', 'info');

            const response = await fetch('http://localhost:8080/api/members/nickname', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nickname: newNickname
                })
            });

            if (response.ok) {
                const data = await response.json();
                showStatus('ë‹‰ë„¤ì„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                // ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸
                currentUserData.nickname = data.data.nickname;
                localStorage.setItem('userInfo', JSON.stringify(currentUserData));

                // ì‚¬ìš©ì ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                setTimeout(() => {
                    showUserSection();
                }, 1500);
            } else {
                const errorData = await response.json();
                showStatus('ë‹‰ë„¤ì„ ìˆ˜ì • ì‹¤íŒ¨: ' + (errorData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ë‹‰ë„¤ì„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
            showStatus('ë‹‰ë„¤ì„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    async function logout() {
        try {
            const accessToken = localStorage.getItem('accessToken');

            if (accessToken) {
                const response = await fetch('http://localhost:8080/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    }
                });
                console.log('ë°±ì—”ë“œ ë¡œê·¸ì•„ì›ƒ ì‘ë‹µ:', response.status);
            }

            // ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ
            if (kakaoInitialized && typeof Kakao !== 'undefined' && Kakao.Auth) {
                try {
                    Kakao.Auth.logout();
                    console.log('ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                } catch (logoutError) {
                    console.warn('ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', logoutError);
                }
            }

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userInfo');
            currentAccessToken = null;
            currentUserData = null;

            // ìƒíƒœ ì´ˆê¸°í™”
            selectedMemberType = 'user';
            validationStatus = {
                nickname: false,
                phone: false,
                businessPhone: false,
                businessLicense: false,
                newNickname: false
            };

            // UI ì´ˆê¸°í™”
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('signupSection').classList.add('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('nicknameUpdateSection').classList.add('hidden');

            // í¼ ì´ˆê¸°í™”
            document.getElementById('nickname').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('address').value = '';
            document.getElementById('businessPhone').value = '';
            document.getElementById('businessLicense').value = '';
            document.getElementById('newNickname').value = '';

            // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.radio-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector('.radio-item').classList.add('selected');
            document.querySelector('input[name="memberType"][value="user"]').checked = true;

            // í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì´ˆê¸°í™”
            document.getElementById('businessFields').classList.remove('show');
            document.getElementById('userFields').classList.remove('hide');

            // ê²€ì¦ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            hideValidation('nicknameValidation');
            hideValidation('phoneValidation');
            hideValidation('businessPhoneValidation');
            hideValidation('businessValidation');
            hideValidation('newNicknameValidation');

            showStatus('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            showStatus('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    // FCM í† í°ì„ ì‹¤ì œë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Firebase SDK í•„ìš”)
    async function getFCMToken() {
        try {
            // ì‹¤ì œ FCM êµ¬í˜„ ì‹œ
            // const messaging = getMessaging();
            // const token = await getToken(messaging, { vapidKey: 'your-vapid-key' });
            // return token;

            // ì„ì‹œë¡œ í…ŒìŠ¤íŠ¸ìš© í† í° ìƒì„±
            const testToken = 'test-fcm-token-' + Date.now();
            localStorage.setItem('fcmToken', testToken);
            return testToken;
        } catch (error) {
            console.error('FCM í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
            return null;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ FCM í† í° ë¯¸ë¦¬ ì¤€ë¹„
    window.addEventListener('load', function() {
        // ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ...

        // FCM í† í° ì¤€ë¹„ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Firebase ì´ˆê¸°í™” í›„)
        getFCMToken().then(token => {
            console.log('ğŸ” FCM í† í° ì¤€ë¹„ ì™„ë£Œ:', token);
        });
    });
</script>
</body>
</html>